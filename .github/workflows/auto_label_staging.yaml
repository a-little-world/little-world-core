name: Auto label staging PRs

on:
  pull_request:
    types:
      - opened
      - edited
      - reopened

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  add_staging_label:
    runs-on: ubuntu-latest
    steps:
      - name: Add 'staging' label if title starts with staging-
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TITLE=$(jq -r .pull_request.title "$GITHUB_EVENT_PATH")
          NUMBER=$(jq -r .pull_request.number "$GITHUB_EVENT_PATH")
          REPO=${{ github.repository }}

          case "$TITLE" in
            staging-*)
              echo "Title matches staging- prefix; ensuring label present"
              # Fetch existing labels to check if already applied
              HAS_LABEL=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$REPO/issues/$NUMBER/labels" | jq -r '.[].name' | grep -x staging || true)
              if [ -z "$HAS_LABEL" ]; then
                curl -s -X POST \
                  -H "Authorization: Bearer $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github+json" \
                  "https://api.github.com/repos/$REPO/issues/$NUMBER/labels" \
                  -d '{"labels":["staging"]}'
              else
                echo "Label already present"
              fi
              ;;
            *)
              echo "Title does not start with staging-; no action"
              ;;
          esac


