name: Deploy temporary env

on:
  pull_request:
    types:
      - synchronize
      - labeled

concurrency:
  group: ${{ github.event.pull_request.id }}
  cancel-in-progress: true

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  make_docs:
    runs-on: ubuntu-latest
    name: Deploy emperial env
    steps:
      - uses: actions/checkout@main
        with:
          token: ${{ secrets.BOT_PAT }}
          submodules: recursive
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Read main_frontend submodule commit
        id: main_frontend_commit
        shell: bash
        run: |
          set -euo pipefail
          if [ -d "front/apps/main_frontend/.git" ] || git -C front/apps/main_frontend rev-parse --git-dir >/dev/null 2>&1; then
            SHA=$(git -C front/apps/main_frontend rev-parse HEAD)
            echo "sha=$SHA" >> $GITHUB_OUTPUT
            echo "MAIN_FRONTEND_REPO_COMMIT_REF=$SHA" >> $GITHUB_ENV
          else
            echo "front/apps/main_frontend not a git repo; leaving empty" >&2
            echo "sha=" >> $GITHUB_OUTPUT
          fi
      - name: Extract branch name
        shell: bash
        run: |
          echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
        id: extract_branch
      - name: Determine Pull ID and if this should be staged
        id: determine_pull_id
        run: |
          pull_number=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")
          # Determine if the PR currently has the 'staging' label
          SHOULD_STAGE=$(jq -r '.pull_request.labels[].name' "$GITHUB_EVENT_PATH" | grep -x 'staging' || true)
          # Determine if the PR currently has the 'android' label
          SHOULD_BUILD_ANDROID=$(jq -r '.pull_request.labels[].name' "$GITHUB_EVENT_PATH" | grep -x 'android' || true)
          echo "SHOULD_STAGE=$SHOULD_STAGE" >> $GITHUB_OUTPUT
          echo "SHOULD_BUILD_ANDROID=$SHOULD_BUILD_ANDROID" >> $GITHUB_OUTPUT
          echo "PULL_NUMBER=$pull_number" >> $GITHUB_OUTPUT
      - name: Prepare Android section content
        id: android_section
        run: |
          BADGE_URL="https://github.com/a-little-world/little-world-native/actions/workflows/android-apk-release.yml/badge.svg?branch=main"
          RUNS_URL="https://github.com/a-little-world/little-world-native/actions/workflows/android-apk-release.yml?query=event%3Aworkflow_dispatch"
          if [ -n "${{ steps.determine_pull_id.outputs.SHOULD_BUILD_ANDROID }}" ]; then
            {
              echo "section<<EOF"
              echo "### Android build"
              echo ""
              echo "[![Workflow status]($BADGE_URL)]($RUNS_URL)"
              echo ""
              echo "Triggered by label 'android'."
              echo "Tag: apk-${{ steps.main_frontend_commit.outputs.sha }}"
              echo "Commit: ${{ steps.main_frontend_commit.outputs.sha }}"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo "section<<EOF"
              echo "### Android build"
              echo ""
              echo "Status: not triggered"
              echo ""
              echo "Add the 'android' label to this PR to trigger a build."
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi
      - name: Trigger Android App build
        env:
          COMMIT_REF: ${{ github.sha }}
        if: steps.extract_branch.outputs.branch != 'main' && steps.determine_pull_id.outputs.SHOULD_BUILD_ANDROID != ''
        run: |
          # Triggers the build in a seperate workflow
          STAGING_HOST="${{ steps.extract_branch.outputs.branch }}-${{ steps.determine_pull_id.outputs.PULL_NUMBER }}.t1m.me"
          export MAIN_FRONTEND_REPO_COMMIT_REF="${{ steps.main_frontend_commit.outputs.sha }}"
          export TAG="apk-${{ steps.main_frontend_commit.outputs.sha }}"
          export NAME="apk-${{ steps.main_frontend_commit.outputs.sha }}"
          export PRERELEASE="true"
          export BOT_PAT="${{ secrets.BOT_PAT }}"
          export BASE_URL="https://${STAGING_HOST}"
          curl -X POST \
            -H "Authorization: Bearer ${BOT_PAT}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/a-little-world/little-world-native/actions/workflows/android-apk-release.yml/dispatches \
            -d '{"ref":"main","inputs":{"tag":"'"${TAG}"'","name":"'"${NAME}"'","prerelease":"'"${PRERELEASE}"'","baseUrl":"'"${BASE_URL}"'","COMMIT_REF":"'"${MAIN_FRONTEND_REPO_COMMIT_REF}"'"}}'
      - name: Delete all littleworld-bot comments
        run: |
          comments=$(curl -s -H "Authorization: token ${{ secrets.BOT_PAT }}" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ steps.determine_pull_id.outputs.PULL_NUMBER }}/comments \
            | jq -r '.[] | select(.user.login=="littleworld-bot") | select(.body | contains("<!-- lw-staging-workflow -->")) | .id')
          for comment in $comments
          do
            curl -s -H "Authorization: token ${{ secrets.BOT_PAT }}" -X DELETE https://api.github.com/repos/${{ github.repository }}/issues/comments/$comment
          done
      - name: Create comment
        uses: peter-evans/create-or-update-comment@v4
        id: create_comment
        if: steps.extract_branch.outputs.branch != 'main' && steps.determine_pull_id.outputs.SHOULD_STAGE != ''
        with:
          token: ${{ secrets.BOT_PAT }}
          issue-number: ${{ steps.determine_pull_id.outputs.PULL_NUMBER }}
          body: |
            ## Deploying Temporary Feature Environment

            > Triggered because PR has label `staging`

            <!-- lw-staging-workflow -->

            1. Setup
            
            ${{ steps.android_section.outputs.section }}
      - name: Setup Emperial Env
        if: steps.extract_branch.outputs.branch != 'main' && steps.determine_pull_id.outputs.SHOULD_STAGE != ''
        id: setup_emperial_env
        run: |
          touch .env
          RANDOM_STRING="$( openssl rand -hex 3 )"
          IMAGE_URL="ghcr.io/a-little-world/little-world-backend/littleworld-epherial-backend:tmp-${{ steps.determine_pull_id.outputs.PULL_NUMBER }}-$RANDOM_STRING"
          touch .env; rm .env; touch .env
          echo "APP_IMAGE_URL=\"$IMAGE_URL\"" >> .env
          NAMESPACE="lw-tmp-env-${{ steps.determine_pull_id.outputs.PULL_NUMBER }}"
          REDIS_URL="redis://redis-service.$NAMESPACE.svc.cluster.local:6379"
          echo "REDIS_URL=\"$REDIS_URL\"" >> .env
          echo "BUILD_TYPE=\"pro\"" >> .env
          echo "ENTRYPOINT=\"./entry.sh\"" >> .env
          echo "REDIS_URL=$REDIS_URL" >> $GITHUB_OUTPUT
          echo "RANDOM_STRING=$RANDOM_STRING" >> $GITHUB_OUTPUT
          echo "IMAGE_URL=$IMAGE_URL" >> $GITHUB_OUTPUT
          echo "NAMESPACE=$NAMESPACE" >> $GITHUB_OUTPUT
      - name: Add build step comment
        uses: peter-evans/create-or-update-comment@v4
        id: update_comment
        if: steps.extract_branch.outputs.branch != 'main' && steps.determine_pull_id.outputs.SHOULD_STAGE != ''
        with:
          token: ${{ secrets.BOT_PAT }}
          comment-id: ${{ steps.create_comment.outputs.comment-id }}
          body: |
            2. Building ![action](https://github.com/a-little-world/little-world-backend/actions/workflows/deploy_staging.yaml/badge.svg?branch=${{ steps.extract_branch.outputs.branch }}&event=pull_request)

            <!-- lw-staging-workflow -->
      - name: Measure start time
        id: start
        run: |
          echo "time=$(date +%s)" >> $GITHUB_OUTPUT
      - name: Build Image
        if: steps.extract_branch.outputs.branch != 'main' && steps.determine_pull_id.outputs.SHOULD_STAGE != ''
        run: |
          echo ${{ secrets.BOT_PAT }} | docker login ghcr.io -u littleworld-bot --password-stdin
          DOCKER_BUILDKIT=1 docker compose build
          DOCKER_BUILDKIT=1 docker compose push
      - name: Measure end time
        id: end
        run: |
          echo "time=$(date +%s)" >> $GITHUB_OUTPUT
      - name: Calculate execution time
        id: execution_time
        run: |
          START=${{ steps.start.outputs.time }}
          END=${{ steps.end.outputs.time }}
          DIFF=$(( END - START ))
          echo "DURATION=$DIFF" >> $GITHUB_OUTPUT
      - name: Add build step comment 2
        uses: peter-evans/create-or-update-comment@v4
        id: update_comment_2
        if: steps.extract_branch.outputs.branch != 'main' && steps.determine_pull_id.outputs.SHOULD_STAGE != ''
        with:
          token: ${{ secrets.BOT_PAT }}
          comment-id: ${{ steps.create_comment.outputs.comment-id }}
          body: |
            Finished in ${{ steps.execution_time.outputs.DURATION }} seconds
            Pushed image to `${{ steps.setup_emperial_env.outputs.IMAGE_URL }}`
            3. Deploy ( to Kubernetes namespace `${{ steps.setup_emperial_env.outputs.NAMESPACE }}` )

            <!-- lw-staging-workflow -->
      - uses: azure/setup-helm@v3
        with:
          version: "latest"
          token: ${{ secrets.BOT_PAT }}
        id: install-helm
      - uses: azure/setup-kubectl@v3
        with:
          version: "latest"
        id: install-kubectl
      - name: Setup Cluster Connection
        if: steps.extract_branch.outputs.branch != 'main' && steps.determine_pull_id.outputs.SHOULD_STAGE != ''
        id: cluster_connection
        run: |
          echo "${{ secrets.ENCRYPTED_KUBE_CONFIG_BASE64 }}" | base64 --decode > kubeconfig.enc
          openssl aes-256-cbc -d -pbkdf2 -in ./kubeconfig.enc -out kubeconfig.yaml -k ${{ secrets.KUBE_CONFIG_PASSWORD }}
          GH_CR_AUTH=$(echo -n "littleworld-bot:${{ secrets.BOT_PAT }}" | base64)
          STAGING_HOST="${{ steps.extract_branch.outputs.branch }}-${{ steps.determine_pull_id.outputs.PULL_NUMBER }}.t1m.me"
          STAGING_URL="https://$STAGING_HOST"
          cat << EOF | while read eval_command; do yq -i eval "$eval_command" ./helm/values.yaml; done
            .rootNamespace = "${{ steps.setup_emperial_env.outputs.NAMESPACE }}"
            .backend.imageURL = "${{ steps.setup_emperial_env.outputs.IMAGE_URL }}"
            .ingress.certManager = true
            .ingress.host = "$STAGING_HOST"
            .registryAuth.token = "$GH_CR_AUTH"
            .registryAuth.use = true
            .backend.env.REDIS_URL = "${{ steps.setup_emperial_env.outputs.REDIS_URL }}"
          EOF
          NAMESPACE=lw-tmp-env-${{ steps.determine_pull_id.outputs.PULL_NUMBER }}
          KUBECONFIG=./kubeconfig.yaml kubectl create namespace $NAMESPACE || true
          KUBECONFIG=./kubeconfig.yaml helm upgrade --install backend-tmp-${{ steps.determine_pull_id.outputs.PULL_NUMBER }} ./helm
          echo "STAGING_URL=$STAGING_URL" >> $GITHUB_OUTPUT
      - name: Add build step comment 3
        uses: peter-evans/create-or-update-comment@v4
        id: update_comment_3
        if: steps.extract_branch.outputs.branch != 'main' && steps.determine_pull_id.outputs.SHOULD_STAGE != ''
        with:
          token: ${{ secrets.BOT_PAT }}
          comment-id: ${{ steps.create_comment.outputs.comment-id }}
          body: |
            4. Done check: [`${{ steps.cluster_connection.outputs.STAGING_URL }}`](${{ steps.cluster_connection.outputs.STAGING_URL }})

            > **Note:** Setting up DNS and solving https challenge can take upto 5 minutes. Chill a little moment :wink:

            <!-- lw-staging-workflow -->

            <details>
            <summary> Details </summary>
             
            - 30 users: `herrduenschnlate+$i@gmail.com` for `$i in {1..30}`
            e.g.: `herrduenschnlate+17@gmail.com:Test123!`
            at `${{ steps.cluster_connection.outputs.STAGING_URL  }}/login`
            - checkout the new user form `${{ steps.cluster_connection.outputs.STAGING_URL  }}/from_v2/userType`
            - admin: `admin@user.com:Admin123!`
            at `${{ steps.cluster_connection.outputs.STAGING_URL  }}/admin`
            - checkout the new admin_panel `${{ steps.cluster_connection.outputs.STAGING_URL  }}/admin_panel_v2/`

            Run build localy
            ```
            echo "<your-git-token>" | docker login ghcr.io -u <your-git-user> --password-stdin
            docker run -it --rm -p 8000:8000 ${{ steps.setup_emperial_env.outputs.IMAGE_URL }}
            ... visit http://localhost:8000
            ```
            You have the image cached loally now, use this to develop locally with pull api access.

            </details>
      - name: Notify Slack Channel
        env:
          SLACK_API_TOKEN: ${{ secrets.SLACK_API_TOKEN }}
          CHANNEL_ID: "C0695SSFPMM"
          MESSAGE: "*Feature environment deployed*\nImage: ${{ steps.setup_emperial_env.outputs.IMAGE_URL }}\nUrl ${{ steps.cluster_connection.outputs.STAGING_URL }}"
        run: |
          pip3 install slack_sdk
          wget -qO- https://raw.githubusercontent.com/tbscode/tims-blog-posts/main/assets/send_slack_message.py | python3 -
      - name: Measure start time
        id: start_tests
        run: |
          echo "time=$(date +%s)" >> $GITHUB_OUTPUT
      - name: Run django tests
        id: run_tests
        if: steps.extract_branch.outputs.branch != 'main' && steps.determine_pull_id.outputs.SHOULD_STAGE != ''
        run: |
          sed -i '/^REDIS_URL/d' .env
          REDIS_URL="redis://host.docker.internal:6379"
          echo "REDIS_URL=\"$REDIS_URL\"" >> .env
          docker run -d --name redis-test -p 6379:6379 redis
          if docker compose run all python manage.py test; then
            echo "test_result=pass" >> $GITHUB_OUTPUT
          else
            echo "test_result=fail" >> $GITHUB_OUTPUT
          fi
          docker rm -f redis-test
      - name: Measure end time
        id: end_tests
        run: |
          echo "time=$(date +%s)" >> $GITHUB_OUTPUT
      - name: Calculate execution time
        id: execution_time_tests
        run: |
          START=${{ steps.start_tests.outputs.time }}
          END=${{ steps.end_tests.outputs.time }}
          DIFF=$(( END - START ))
          echo "DURATION=$DIFF" >> $GITHUB_OUTPUT
      - name: Add build step comment 5
        uses: peter-evans/create-or-update-comment@v4
        id: update_comment_5
        if: steps.extract_branch.outputs.branch != 'main' && steps.determine_pull_id.outputs.SHOULD_STAGE != ''
        with:
          token: ${{ secrets.BOT_PAT }}
          comment-id: ${{ steps.create_comment.outputs.comment-id }}
          body: |

            Test Result: ${{ steps.run_tests.outputs.test_result }} ${{
              fromJSON('{"fail":"❌","pass":"✅"}')[steps.run_tests.outputs.test_result]
            }}
            Duration: ${{ steps.execution_time_tests.outputs.DURATION }} seconds

            <!-- lw-staging-workflow -->
